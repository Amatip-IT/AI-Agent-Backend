openapi: 3.0.3
info:
  title: Chatbot API
  description: A ChatGPT-like API using DeepSeek + MongoDB + JWT
  version: 1.0.0
servers:
  - url: http://localhost:5000
    description: Local dev server
  - url: https://ai-agent-backend-gkwf.onrender.com
    description: Production server
    
components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT

  schemas:
    # --- Auth Schemas ---
    RegisterRequest:
      type: object
      required: [username, email, password]
      properties:
        username:
          type: string
          example: "john_doe"
        email:
          type: string
          format: email
          example: "john@example.com"
        password:
          type: string
          format: password
          example: "securePass123!"

    LoginRequest:
      type: object
      required: [identifier, password]
      properties:
        identifier:
          type: string
          description: Can be either username or email (flexible field names accepted)
          example: "john_doe or john@example.com"
        username_or_email:
          type: string
          description: Alias for identifier
        username:
          type: string
        email:
          type: string
          format: email
        password:
          type: string
          format: password

    TokenResponse:
      type: object
      properties:
        access_token:
          type: string
          description: JWT access token
        message:
          type: string
          example: "Login successful"

    UserProfile:
      type: object
      properties:
        _id:
          type: string
          example: "507f1f77bcf86cd799439011"
        username:
          type: string
        email:
          type: string
          format: email
        avatar_url:
          type: string
          format: uri
          nullable: true
          example: "/static/avatars/507f1f77bcf86cd799439011_profile.jpg"
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time

    UpdateProfileRequest:
      type: object
      properties:
        username:
          type: string
        email:
          type: string
          format: email
      example:
        username: "new_username"
        email: "new@email.com"

    AvatarResponse:
      type: object
      properties:
        message:
          type: string

    Error:
      type: object
      properties:
        error:
          type: string

    # --- Reusable Responses ---
    BadRequest:
      description: Bad request - missing or invalid fields
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    Unauthorized:
      description: Invalid or missing credentials / token
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    Forbidden:
      description: Access denied
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

paths:
  # ========================================
  # 1. REGISTER
  # ========================================
  /auth/register:
    post:
      summary: Register a new user
      tags: [Auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RegisterRequest'
      responses:
        '201':
          description: User created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Response'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # ========================================
  # 2. LOGIN
  # ========================================
  /auth/login:
    post:
      summary: Login with username or email
      description: |
        Accepts flexible identifier fields: `identifier`, `username_or_email`, `username`, or `email`.
        Returns JWT token on success.
      tags: [Auth]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/LoginRequest'
            examples:
              by_username:
                summary: Login with username
                value:
                  username: "john_doe"
                  password: "securePass123!"
              by_email:
                summary: Login with email
                value:
                  email: "john@example.com"
                  password: "securePass123!"
              using_identifier:
                summary: Using generic identifier field
                value:
                  identifier: "john_doe"
                  password: "securePass123!"
      responses:
        '200':
          description: Login successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TokenResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '400':
          $ref: '#/components/responses/BadRequest'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # ========================================
  # 3. LOGOUT
  # ========================================
  /auth/logout:
    post:
      summary: Logout and revoke JWT
      description: Adds the token's JTI to blacklist. Cookie is cleared.
      tags: [Auth]
      security:
        - bearerAuth: []
      responses:
        '200':
          description: Successfully logged out
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Response'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # ========================================
  # 4. GET PROFILE
  # ========================================
  /auth/profile:
    get:
      summary: Get current user profile
      tags: [Auth]
      security:
        - bearerAuth: []
      responses:
        '200':
          description: User profile data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/UserProfile'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '404':
          $ref: '#/components/responses/NotFound'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

    put:
      summary: Update user profile
      description: Update username and/or email
      tags: [Auth]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateProfileRequest'
      responses:
        '200':
          description: Profile updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Response'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          description: Internal server error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # ========================================
  # 5. UPLOAD AVATAR
  # ========================================
  /auth/profile/avatar:
    post:
      summary: Upload user avatar
      description: |
        Uploads an image (PNG, JPG, JPEG, GIF). Saved as `/static/avatars/<user_id>_<filename>`.
        Returns the public URL.
      tags: [Auth]
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              properties:
                avatar:
                  type: string
                  format: binary
                  description: Image file (max 5MB recommended)
      responses:
        '200':
          description: Avatar uploaded successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  avatar_url:
                    type: string
                    format: uri
                    example: "/static/avatars/507f1f77bcf86cd799439011_avatar.jpg"
        '400':
          description: No file, invalid file type, or empty filename
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '500':
          description: Upload failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  # ========================================
  # Existing Chat Endpoints (unchanged, kept for context)
  # ========================================
  /api/chats:
    post:
      summary: Create a new chat
      security:
        - bearerAuth: []
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                title:
                  type: string
                  default: "New Chat"
      responses:
        '201':
          description: Chat created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Chat'
        '401':
          $ref: '#/components/responses/Unauthorized'

    get:
      summary: List user's chats
      security:
        - bearerAuth: []
      responses:
        '200':
          description: List of chats
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Chat'
        '401':
          $ref: '#/components/responses/Unauthorized'

  /api/chats/{chat_id}/messages:
    post:
      summary: Send a message
      security:
        - bearerAuth: []
      parameters:
        - name: chat_id
          in: path
          required: true
          schema: { type: string }
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/SendMessageRequest'
      responses:
        '200':
          description: Assistant reply
          content:
            application/json:
              schema:
                type: object
                properties:
                  content: { type: string }
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'

    get:
      summary: Get chat messages
      security:
        - bearerAuth: []
      parameters:
        - name: chat_id
          in: path
          required: true
          schema: { type: string }
      responses:
        '200':
          description: Messages
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Message'
        '404':
          $ref: '#/components/responses/NotFound'
        '401':
          $ref: '#/components/responses/Unauthorized'

  # --- Reusable Responses (moved into components) ---
  /components/responses:
    BadRequest:
      description: Bad request
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    Unauthorized:
      description: Unauthorized
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'
    NotFound:
      description: Not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'